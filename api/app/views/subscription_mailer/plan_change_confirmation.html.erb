<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plan Change Confirmation - SpaceGrow</title>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; background-color: #f4f4f4; }
    .container { max-width: 600px; margin: 0 auto; background-color: white; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 20px; text-align: center; }
    .content { padding: 30px 20px; }
    .change-summary { background-color: #f8f9fa; padding: 25px; border-radius: 12px; border-left: 4px solid #667eea; margin: 20px 0; }
    .plan-comparison { display: flex; justify-content: space-between; margin: 20px 0; }
    .plan-box { background-color: #f8f9fa; padding: 20px; border-radius: 8px; width: 45%; }
    .old-plan { border-left: 4px solid #6c757d; }
    .new-plan { border-left: 4px solid #28a745; }
    .upgrade-highlight { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 12px; margin: 20px 0; }
    .downgrade-highlight { background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white; padding: 20px; border-radius: 12px; margin: 20px 0; }
    .cta-button { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 10px; }
    .cta-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
    .footer { background-color: #f8f9fa; padding: 20px; text-align: center; font-size: 14px; color: #666; }
    .confirmed-badge { background-color: #28a745; color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold; display: inline-block; }
    .effective-date { background-color: #e8f4f8; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8; margin: 20px 0; }
    .feature-change { margin: 10px 0; }
    .feature-added { color: #28a745; font-weight: bold; }
    .feature-removed { color: #dc3545; font-weight: bold; }
    .feature-same { color: #6c757d; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>📋 Plan Change Confirmed</h1>
      <p>Your SpaceGrow subscription has been updated</p>
      <div class="confirmed-badge">
        CHANGE CONFIRMED
      </div>
    </div>

    <!-- Main Content -->
    <div class="content">
      <p>Hi <%= @user.first_name || @user.email.split('@').first.titleize %>,</p>

      <p>Your plan change request has been successfully processed. Your SpaceGrow subscription has been updated with your new plan benefits and pricing.</p>

      <!-- Change Summary -->
      <div class="change-summary">
        <h3>📊 Change Summary</h3>
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
          <span>Previous Plan:</span>
          <span><strong><%= @change_data[:old_plan] %></strong></span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
          <span>New Plan:</span>
          <span><strong><%= @change_data[:new_plan] %></strong></span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
          <span>Effective Date:</span>
          <span><strong><%= @change_data[:effective_date].strftime("%B %d, %Y") %></strong></span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 10px 0;">
          <span>Change Type:</span>
          <span><strong><%= @change_data[:change_type]&.titleize || 'Plan Update' %></strong></span>
        </div>
      </div>

      <!-- Effective Date -->
      <div class="effective-date">
        <h4>📅 When Changes Take Effect</h4>
        <p><strong>Effective Date:</strong> <%= @change_data[:effective_date].strftime("%B %d, %Y at %I:%M %p") %></p>
        <% if @change_data[:effective_date] > Time.current %>
          <p>Your plan changes will be activated on the date above. Until then, your current plan remains active.</p>
        <% else %>
          <p>Your plan changes are now active and all new features are available immediately.</p>
        <% end %>
      </div>

      <!-- Plan Comparison -->
      <h3>🔄 Plan Comparison</h3>
      <div class="plan-comparison">
        <div class="plan-box old-plan">
          <h4><%= @change_data[:old_plan] %> Plan</h4>
          <p style="font-size: 14px; color: #666;">Previous Plan</p>
          <% if @change_data[:old_plan_features] %>
            <ul style="margin: 10px 0; padding-left: 15px;">
              <% @change_data[:old_plan_features].each do |feature| %>
                <li style="font-size: 14px;"><%= feature %></li>
              <% end %>
            </ul>
          <% end %>
        </div>
        
        <div class="plan-box new-plan">
          <h4><%= @change_data[:new_plan] %> Plan</h4>
          <p style="font-size: 14px; color: #666;">New Plan</p>
          <% if @change_data[:new_plan_features] %>
            <ul style="margin: 10px 0; padding-left: 15px;">
              <% @change_data[:new_plan_features].each do |feature| %>
                <li style="font-size: 14px;"><%= feature %></li>
              <% end %>
            </ul>
          <% end %>
        </div>
      </div>

      <!-- Change Highlights -->
      <% is_upgrade = @change_data[:change_type]&.downcase&.include?('upgrade') %>
      <% if is_upgrade %>
        <div class="upgrade-highlight">
          <h3>🚀 Congratulations on Your Upgrade!</h3>
          <p>You've unlocked additional features and capabilities:</p>
          <% if @change_data[:added_features] %>
            <ul style="margin: 15px 0;">
              <% @change_data[:added_features].each do |feature| %>
                <li class="feature-added">✅ <%= feature %></li>
              <% end %>
            </ul>
          <% else %>
            <ul style="margin: 15px 0;">
              <li>✅ Enhanced device monitoring capabilities</li>
              <li>✅ Advanced analytics and reporting</li>
              <li>✅ Priority support access</li>
              <li>✅ Extended data retention</li>
            </ul>
          <% end %>
        </div>
      <% else %>
        <div class="downgrade-highlight">
          <h3>📋 Plan Change Details</h3>
          <p>Your plan has been updated. Here's what's changed:</p>
          <% if @change_data[:feature_changes] %>
            <ul style="margin: 15px 0;">
              <% @change_data[:feature_changes].each do |change| %>
                <li><%= change %></li>
              <% end %>
            </ul>
          <% else %>
            <p>Your service level has been adjusted according to your new plan selection. All core monitoring features remain available.</p>
          <% end %>
        </div>
      <% end %>

      <!-- Billing Changes -->
      <% if @change_data[:billing_changes] %>
        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #17a2b8;">
          <h4>💳 Billing Changes</h4>
          <% if @change_data[:new_price] && @change_data[:old_price] %>
            <p>
              <strong>Previous Price:</strong> $<%= sprintf("%.2f", @change_data[:old_price]) %>/month<br>
              <strong>New Price:</strong> $<%= sprintf("%.2f", @change_data[:new_price]) %>/month
            </p>
          <% end %>
          <% if @change_data[:proration_amount] %>
            <p><strong>Proration Amount:</strong> $<%= sprintf("%.2f", @change_data[:proration_amount]) %></p>
          <% end %>
          <% if @change_data[:next_billing_date] %>
            <p><strong>Next Billing Date:</strong> <%= @change_data[:next_billing_date].strftime("%B %d, %Y") %></p>
          <% end %>
        </div>
      <% end %>

      <!-- Quick Actions -->
      <div style="text-align: center; margin: 30px 0;">
        <a href="<%= Rails.application.config.app_host %>/dashboard" class="cta-button" style="color: white;">
          📊 Explore Your Dashboard
        </a>
        <a href="<%= Rails.application.config.app_host %>/account/subscription" class="cta-button" style="color: white;">
          ⚙️ Manage Subscription
        </a>
      </div>

      <!-- What's Next -->
      <div style="background-color: #e8f4f8; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8; margin: 30px 0;">
        <h4>🎯 What's Next?</h4>
        <ul>
          <% if is_upgrade %>
            <li><strong>Explore New Features:</strong> Check out the enhanced capabilities in your dashboard</li>
            <li><strong>Upgrade Devices:</strong> You can now add more devices to your monitoring network</li>
            <li><strong>Advanced Analytics:</strong> Access detailed reporting and trend analysis</li>
          <% end %>
          <li><strong>Review Settings:</strong> Ensure your alert preferences match your new plan</li>
          <li><strong>Update Billing:</strong> Verify your payment method is current</li>
          <li><strong>Get Support:</strong> Contact us if you have questions about your new plan</li>
        </ul>
      </div>

      <!-- Support -->
      <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 30px 0;">
        <h4>Questions About Your Plan Change? 🤝</h4>
        <p>Our team is here to help you make the most of your new plan:</p>
        <ul>
          <li>📧 <strong>Email:</strong> <a href="mailto:support@SpaceGrow.com">support@SpaceGrow.com</a></li>
          <li>💬 <strong>Live Chat:</strong> Available in your dashboard</li>
          <li>📞 <strong>Phone:</strong> 1-800-XSPACE-1</li>
          <li>📚 <strong>Help Center:</strong> <a href="<%= Rails.application.config.app_host %>/help">Plan guides and tutorials</a></li>
        </ul>
      </div>

      <p style="margin-top: 30px;">
        Thank you for choosing SpaceGrow. We're excited to support your IoT monitoring journey with your updated plan!<br><br>
        <strong>The SpaceGrow Team</strong>
      </p>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>
        SpaceGrow • IoT Device Management Platform<br>
        <a href="<%= Rails.application.config.app_host %>">Dashboard</a> • 
        <a href="<%= Rails.application.config.app_host %>/account/subscription">Subscription</a> • 
        <a href="<%= Rails.application.config.app_host %>/support">Support</a>
      </p>
      <p style="font-size: 12px; margin-top: 15px;">
        Subscription ID: <%= @subscription.id %> • Change effective <%= @change_data[:effective_date].strftime("%B %d, %Y") %>
      </p>
    </div>
  </div>
</body>
</html>